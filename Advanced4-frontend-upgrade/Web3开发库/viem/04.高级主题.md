# Viem 高级主题精讲

## 4.1 性能优化
### 批量请求处理
```typescript
// 启用批量 RPC 模式
const client = createPublicClient({
  batch: {
    multicall: {
      wait: 50,   // 等待窗口 50ms
      batchSize: 1024 * 2
    },
    rpc: {
      // 合并 JSON-RPC 请求
      wait: 100,
      batchSize: 1024 
    }
  }
})

// 并发请求示例（自动合并为单个RPC）
const [block, balance, logs] = await Promise.all([
  client.getBlock(),
  client.getBalance({ address: '0x...' }),
  client.getLogs({ address: '0x...' })
])
```

### 缓存策略配置
```typescript
const customClient = createPublicClient({
  cacheTime: 15_000, // 15秒缓存
  // 高级缓存配置
  key: 'mainnet-client',
  // 请求去重策略
  dedup: {
    interval: 500,
    equals: (a, b) => a.method === b.method
  }
})
```

### 自定义 Transport 层
```typescript
import { createTransport, custom } from 'viem'

// 自定义 HTTP Transport
const alchemyTransport = http('https://eth-mainnet.g.alchemy.com/v2/KEY', {
  fetchOptions: { 
    headers: { 'X-Custom-Header': 'value' }
  },
  retryCount: 5, // 自定义重试策略
  timeout: 30_000
})

// WebSocket 重连策略
const wsTransport = webSocket('wss://...', {
  reconnect: {
    retries: Infinity,
    delay: 5000
  }
})
```

## 4.2 原理深入
### 序列化机制
```typescript
// 交易参数序列化示例
import { serializeTransaction } from 'viem'

const serialized = serializeTransaction({
  chainId: 1,
  to: '0x...',
  value: parseEther('1')
})

// 日志反序列化
const log = decodeEventLog({
  abi: erc20Abi,
  data: '0x...',
  topics: [...]
})
```

### 错误处理体系
```typescript
// 错误类型识别
try {
  await client.getBlock({ blockNumber: 999999999n })
} catch (err) {
  if (err instanceof ChainError) {
    console.error('链配置错误:', err.details)
  }
  if (err.name === 'HttpRequestError') {
    console.error('网络错误:', err.status)
  }
}

// 自定义错误处理器
const client = createPublicClient({
  onError: (error) => {
    reportToSentry(error)
    throw new CustomError('Viem Error', error)
  }
})
```

### 源码结构分析
```typescript
// 核心模块路径
src/
├─ chains/      // 链配置
├─ actions/     // RPC 方法实现
├─ types/       // 类型定义
├─ utils/       // 序列化/编码工具
└─ clients/     // 客户端实现

// 典型调用链路
WalletClient.sendTransaction()
  → prepareRequest()
  → transport.request()
  → parseTransactionResponse()
```

## 调试与验证
1. 性能测量：使用 `performance.now()` 对比批量/单次请求
2. 缓存验证：重复调用相同方法观察网络请求次数
3. 错误覆盖：模拟网络错误测试降级方案
4. 源码跟踪：在 VSCode 中 ⌘+Click 跳转类型定义

推荐调试工具：
- Chrome DevTools 的 Performance 面板
- Wireshark 抓包分析 Transport 层
- Viem 的 debug 模式：
  ```bash
  DEBUG=viem:* npm run dev
  ```

学习资源：
- 核心模块源码：https://github.com/wagmi-dev/viem/tree/main/src
- 编码规范：https://viem.sh/docs/contributing
- 性能白皮书：https://viem.sh/docs/benchmarks
